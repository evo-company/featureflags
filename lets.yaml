shell: bash

env:
  DOCKER_BUILDKIT: "1"
  COMPOSE_DOCKER_CLI_BUILD: "1"
  CURRENT_UID:
    sh: echo "`id -u`:`id -g`"

commands:
  build-prod:
    description: build server image with embeded frontend
    options: |
      Usage: lets build-prod [--tag=<tag>]

      Options:
        --tag=<tag>, -t                 Set container tag [default: dev]
    cmd: |
      docker build \
        -f Dockerfile \
        -t featureflags-server:${LETSOPT_TAG} \
        --target prd \
        .

  build-dev:
    description: build dev server image
    cmd: |
      docker build \
        -f Dockerfile \
        -t featureflags-server \
        --target dev \
        .

  build-test:
    description: build test server image
    cmd: |
      docker build \
        -f Dockerfile \
        -t featureflags-server-test \
        --target test \
        .

  build-docs:
    description: build docs image
    cmd: |
      docker build \
        -f Dockerfile \
        -t featureflags-docs \
        --target docs \
        .

  build-ui:
    description: build ui image
    cmd: |
      # TODO rename dockerfile to Dockerfile
      docker build \
        -f Dockerfile \
        -t featureflags-assets \
        --target assets-dev \
        .

  run:
    description: run whole application
    depends:
      - build-dev
    cmd: docker-compose up server postgres

  web:
    description: run web server
    depends:
      - build-dev
    cmd: docker-compose up web

  rpc:
    description: run grpc server
    depends:
      - build-dev
    cmd: docker-compose up rpc

  test:
    description: run tests
    depends:
      - build-test
    cmd: docker-compose run --rm test

  postgres:
    description: run postgres
    cmd: docker-compose up postgres

  apply-migration-dev:
    description: Apply migrations to local postgres
    depends:
      - build-dev
    cmd: docker-compose run --rm backend python3 -m featureflags.server config.yaml@local alembic -- upgrade head

  rollback-migration-dev:
    description: Rollback migrations to local postgres
    depends:
      - build-dev
    cmd: docker-compose run --rm backend python3 -m featureflags.server config.yaml@local alembic -- downgrade -1

  create-migration:
    description: |
      Create new migration file
      Example: lets create-migration add_date_created_column_to_user_table
    depends:
      - build-dev
    cmd:
      - docker-compose run --rm backend python3 -m featureflags.server config.yaml@local alembic -- revision --autogenerate -m

  ui:
    description: Build and run ui local
    work_dir: ./ui
    cmd: npm run dev

  psql:
    cmd: docker-compose exec postgres psql -U postgres -d featureflags

  update-deps:
    description: generate new setup.txt
    depends:
      - build-dev
    cmd: |
      docker-compose run --rm backend pip-compile \
        server/setup.py --output-file server/setup.txt

  update-test-deps:
    description: generate new requirements-tests.txt
    depends:
      - build-dev
    cmd: |
      docker-compose run --rm backend pip-compile \
        requirements-tests.in --output-file requirements-tests.txt

  update-docs-deps:
    description: generate new requirements-docs.txt
    depends:
      - build-dev
    cmd: |
      docker-compose run --rm backend pip-compile \
        requirements-docs.in --output-file requirements-docs.txt

  gen-docs:
    description: generate docs
    depends:
      - build-docs
    cmd: |
      docker-compose run --rm docs
